name: ${COMPOSE_PROJECT_NAME}
services:
  db:
    image: mariadb:10.5
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD}
      MYSQL_DATABASE: ${DB_NAME}
      MYSQL_USER: ${DB_USER}
      MYSQL_PASSWORD: ${DB_PASSWORD}
    volumes:
      - db_data:/var/lib/mysql

  wordpress:
    build: .
    user: "33:33"
    depends_on:
      - db
    ports:
      - "${LOCAL_PORT}:80"
    restart: always
    environment:
      WORDPRESS_DB_HOST: db:3306
      WORDPRESS_DB_NAME: ${DB_NAME}
      WORDPRESS_DB_USER: ${DB_USER}
      WORDPRESS_DB_PASSWORD: ${DB_PASSWORD}
      # Variables du site accessibles dans PHP via getenv()
      SITE_NAME: ${SITE_NAME}
      SITE_TITLE: ${SITE_TITLE}
      SITE_DESCRIPTION: ${SITE_DESCRIPTION}
      SITE_COPYRIGHT: ${SITE_COPYRIGHT}
      SITE_URL: ${SITE_URL}
      PROD_URL: ${PROD_URL}
      FOLDER_NAME: ${FOLDER_NAME}
    volumes:
      - ./wp:/var/www/html
      - ./assets:/var/www/html/wp-content/themes/generatepress-child/
      - ./assets:/var/www/html/wp-content/uploads/custom

      # Le fichier styles.css sera accessible dans /var/www/html/wp-content/uploads/custom/css/styles.css
      # via le montage du dossier assets ci-dessus

  wpcli:
    image: wordpress:cli
    depends_on:
      - wordpress
    volumes:
      - ./wp:/var/www/html
      - ./assets:/assets
    environment:
      WP_CLI_CACHE_DIR: /tmp/wp-cli-cache
      PHP_MEMORY_LIMIT: 512M
      # Variables du site pour les scripts WP-CLI
      SITE_NAME: ${SITE_NAME}
      SITE_TITLE: ${SITE_TITLE}
      SITE_DESCRIPTION: ${SITE_DESCRIPTION}
      SITE_URL: ${SITE_URL}
      ADMIN_USER: ${ADMIN_USER}
      ADMIN_PASSWORD: ${ADMIN_PASSWORD}
      ADMIN_EMAIL: ${ADMIN_EMAIL}
    entrypoint: wp
    user: "33:33"

volumes:
  db_data:
    name: ${COMPOSE_PROJECT_NAME}_db_data
